<!DOCTYPE html>
<html>
  <head>
    <title>Lines</title>
    <script type="text/javascript" src="../vendor/d3.js"></script>
    <script type="text/javascript" src="../vendor/d3.layout.js"></script>
    <script type="text/javascript" src="../src/d3.tip.js"></script>
    <style type="text/css">
      body {
        padding: 100px;
      }

      path.domain {
        display: none;
      }

      .d3-tip path, .d3-tip rect {
        fill: #005dae;
        font-weight: bold;
      }

      .d3-tip text {
        fill: #fff;
        font-size: 12px;
        stroke: none;
        font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
      }

      .rule {
        stroke-width: 1px;
        stroke: #c00;
        shape-rendering: crispedges;
      }

      g.line path {
        fill: none;
        stroke-width: 2px;
      }

      circle {
        fill: #fff;
        stroke: #c00;
        stroke-width: 2px;
      }

      text {
        font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
        font-size: 10px;
        fill: #777;
      }

      rect {
        fill: #2892eb;
      }

      line.tick {
        stroke-width: 1px;
        stroke: #ddd;
        shape-rendering: crispedges;
      }
    </style>
  </head>
  <body>
  <div id="bars"></div>
  <div id="circles"></div>

  <script type="text/javascript">
  var pl = 20, pt = 20, pr = 20, pb = 20,
      w     = 800 - pl - pr,
      h     = 300 - pt - pb,
      linex, liney,
      tip = d3.svg.tip()
        .orient('top')
        .padding(4)
        .text(function(d) { return d; })
        .attr('class', 'd3-tip');



  // Base vis layer
  var vis = d3.select('#bars')
    .append('svg')
      .attr('width', w + (pl + pr))
      .attr('height', h + pt + pb)
      .attr('class', 'viz')
    .append('g')
      .attr('transform', "translate(" + pl + "," + pt + ")")

  d3.json('data.json', function(data) {
    var totals  = data.map(function(d) { return d.total }),
        max     = d3.max(totals),
        // Scales
        x       = d3.scale.ordinal().domain(d3.range(totals.length)).rangeRoundBands([0, w - pl - pr], 0.1)
        y       = d3.scale.linear().domain([0, max]).range([h, 0]),
        yAxis   = d3.svg.axis().scale(y).orient("left").ticks(3).tickSize(-w + pl + pr),
        xAxis   = d3.svg.axis().scale(x).tickSize(8);

    vis.append("g")
      .attr("class", "y axis")
      .call(yAxis)

    var bgroups = vis.selectAll('g.bar')
        .data(totals)
      .enter().append('g')
        .attr('transform', function(d, i) { return "translate(" + x(i) + ",0)" })

    bgroups.append('rect')
      .attr('width', x.rangeBand())
      .attr('height', function(d) { return h - y(d) })
      .attr('y', function(d) { return y(d) })
      .on('mouseover', function(d) {
        d3.select(this).style('fill', 'red')
        var rect = this.getBoundingClientRect(),
            bbox = this.getBBox(),
            // trans = this.getTransformToElement(),
            scree = this.getScreenCTM(),
            ctm   = this.getCTM(),
            x = ctm.e - ctm.f + (bbox.width / 2),
            y = bbox.y;

        linex.transition()
          .attr('x1', x)
          .attr('x2', x)

        liney.transition()
          .attr('y1', y)
          .attr('y2',y)
      })
      .on('mouseout', function(d) {
        d3.select(this).style('fill', '#2892eb')
      })

    vis.append('g')
      .attr('class', 'x axis')
      .attr("transform", "translate(0," + h + ")")
      .call(xAxis)
    .selectAll('.x.axis g')
      .style('display', function(d, i) { return i % 3 != 0 ? 'none' : 'block' })


    // debugging stuff
    var linex = vis.append('line')
      .attr("x1", 0)
      .attr("y1", 0)
      .attr("x2", 0)
      .attr("y2", h)
      .attr('class', 'rule')

    var liney = vis.append('line')
      .attr("x1", 0)
      .attr("y1", 0)
      .attr("x2", w)
      .attr("y2", 0)
      .attr('class', 'rule')
  })
  </script>
  </body>
</html>
